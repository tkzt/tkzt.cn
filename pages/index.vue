<template>
  <div class="flex items-center flex-wrap flex-col flex-col-reverse md:flex-row">
    <div class="w-100% shrink-0 md:w-50% mt-6 md:mt-0">
      <div class="ma-auto tracking-.37">
        <div class="md:text-5xl text-2xl">ä½ å¥½ã€‚</div>
        <div class="my-6 md:text-2xl text-xl">
          è¿™æ˜¯é™¶åº·çš„ä¸»é¡µã€‚æ­¤äººï¼š
        </div>
        <div class="text-sm md:text-4 lh-6.18 tracking-.37 text-justify">
          äº 2019 å¹´æ¯•ä¸šäº<a href="https://www.bing.com/search?q=%E8%A0%A1%E4%B8%93" target="_blank"
            class="link">è ¡æ¹–ä¸“ç§‘<i class="outlink">
            </i></a>ï¼Œç»§è€Œæˆä¸ºä¸€åæ–°ç”Ÿä»£å†œæ°‘å·¥ï¼›æœ€è¿‘åœ¨<client-only><a @click="$router.push(recentMoment?._path)"
              class="link">{{
                recentMoment?.title
              }}</a></client-only>ï¼›ç”Ÿæ€§èƒ†å°ï¼Œçˆ±å¥½å’Œå¹³ï¼Œä¸å–„è¡¨è¾¾ï¼Œå—œç¡ï¼ŒåŒæ—¶å–œçˆ±æ­¦ä¾ ä¸ç§‘å¹»ï¼›å…ˆååœ¨å—äº¬ã€ä¸Šæµ·ã€æ— é”¡ã€ä¸Šæµ·ç—›æ¨ã€æ”¹é€ ã€äº²æ‰‹å †ç Œè¿‡è‹¥å¹²åº§<a
            class="link"
            @click="$router.push('/blogs/some_work_work')">å±å±±</a>ï¼Œè‰°éš¾ç§¯æ”’è´¢å¯Œçš„åŒæ—¶ï¼Œè½»æ˜“åœ°å¾—åˆ°äº†è‚¥èƒ–ã€è‚©é¢ˆç–¾ç—…ã€é«˜è¡€å‹ï¼›æ˜¯ä¸€ä¸ª<a
            href="https://fine-weather-gallery.tkzt.cn" target="_blank" class="link">å¥½å¤©æ°”æ‘„å½±<i
              class="outlink"></i></a>çˆ±å¥½è€…ï¼›èƒ¡ä¹±å­¦è¿‡ä¸€äº›èŠ±æ‹³ç»£è…¿ï¼Œé€ äº†ä¸€äº›<a @click="$router.push('/boring-plans')"
            class="link">ç©å…·</a>ï¼›æƒ æ™®ç²¾çµä¸­å¿ƒâ€œ<é»‘ç¥è¯Â·æ‚Ÿç©º>é€Ÿé€šèµ›â€<a
              @click="$router.push('/blogs/241229_black_myth_speed_race')"
              class="link">å† å†›ğŸ†</a>ï¼›ç”±æ·®æ‰¬èœç»„æˆï¼Œæ›´å–œæ¬¢è‹å¸®èœï¼Œæœ€çˆ±é¸¡è›‹çŒé¥¼ã€ç…é¥¼é¦ƒå­ç±»é£Ÿç‰©ï¼›å¶å°”å¿ƒè¡€æ¥æ½®ï¼Œå†™ä¸€äº›<a
              @click="$router.push('/boring-blogs')"
              class="link">ä¸å ªå’è¯»çš„æ–‡ç« </a>ï¼›å–œæ¬¢çœ‹å²©äº•ä¿ŠäºŒã€å§œæ–‡çš„ç”µå½±ï¼Œå¬å®‹å†¬é‡ã€é€¼å“¥ã€æå®—ç››ã€å‘¨æ°ä¼¦ã€é©¬é£ã€ç‹è²å’Œæ–°è£¤å­çš„æ­Œã€‚
        </div>
        <div class="mt-6">
          <client-only>
            <!-- Since using `isDark`, so client only. -->
            <emoji-reaction :reactor="reactor" :react="react" :unreact="unreact"
              :getReactions="getReactions" :dark="isDark" :emojis="emojis" />
          </client-only>
        </div>
      </div>
    </div>
    <div class="grow-1 items-center flex md:(justify-end md:mt-0) mt-6 justify-center">
      <div class="relative">
        <img src="https://fine-weather-gallery.tkzt.cn/thumbnail/1.jpg"
          class="md:w-300px w-100% min-w-300px min-h-200px dark:bg-[rgba(0,0,0,.37)] bg-[rgba(0,0,0,.05)] rounded" />
        <div class="text-right caption mt-1 text-xs md:(text-sm mt-3)">
          2020
          <span class="mx-1">Â·</span>
          æ— é”¡
          <span class="mx-1">Â·</span>
          ã€Œçª—å°ä¸Šçš„é›èŠã€
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue'
import { EmojiReaction } from 'emoji-reaction/lib/index.esm'
import FingerprintJS from '@fingerprintjs/fingerprintjs'
import { asyncComputed, useDark } from '@vueuse/core'
import dayjs from 'dayjs'

const emojiReactionKey = 'tkzt.cn'
const isDark = useDark()
const { public: { apiBase } } = useRuntimeConfig()
const reactor = ref('')
const emojis = ['ğŸ‘', 'ğŸ‘', 'ğŸ˜„', 'ğŸ‰', 'ğŸ˜•', 'â¤ï¸', 'ğŸš€', 'ğŸ‘€']
const emojiReactions = ref([])

const recentMoment = asyncComputed(async () => {
  const moments = (await queryContent('logs').find()).filter(m => m._path !== '/logs').sort((a, b) => (dayjs(b.date).diff(dayjs(a.date))) || 1)
  return moments[0] || {
    title: '...',
    _path: '/'
  }
})

function react(reaction) {
  useFetch(`${apiBase}/reactions`, { method: 'post', body: { reaction, reactor, objective: emojiReactionKey } })
}

function unreact(reaction) {
  const theReaction = emojiReactions.value.find(r => r.reaction === reaction && r.reactor === reactor.value)
  if (!theReaction) return
  useFetch(`${apiBase}/reactions/${theReaction.id}`, { method: 'delete' })
}

async function getReactions() {
  const { data } = await (
    await fetch(`${apiBase}/reactions?objective=${emojiReactionKey}`, { method: 'get' })
  ).json()
  let reactions = data || []
  emojiReactions.value = reactions

  reactions = Object.entries(reactions.reduce((acc, cur) => {
    if (!acc[cur.reaction]) acc[cur.reaction] = []
    acc[cur.reaction].push(cur.reactor)
    return acc
  }, {})).map(([reaction, reactors]) => ({
    reaction, reactors
  }))
  return reactions
}

onMounted(async () => {
  const fp = await FingerprintJS.load();
  const result = await fp.get()
  reactor.value = result.visitorId
})
</script>

<style scoped>
.link {
  --at-apply: decoration-none c-inherit relative inline-block cursor-pointer;
  --at-apply: before:content-[''] before:h-5px before:bg-[var(--tkzt-primary)] before:w-100% before:inline-block;
  --at-apply: before:absolute before:bottom-0 before:left-0 before:z--1 before:rd-1 before:hover:bg-[var(--tkzt-primary-dark)];
}

.outlink {
  --at-apply: inline-block scale-75 origin-b i-mdi-arrow-top-right;
}
</style>
